<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–∞—à—Ç–µ—Ç –ö–æ—Å–∏ ‚Äî –¥—Ä—É–∑—å—è</title>
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;background:#eef2e6;overflow:hidden;font-family:'Comic Sans MS',sans-serif}
  /* header */
  #header{position:fixed;top:0;left:0;width:100%;min-height:56px;padding:6px 10px;background:#fff;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;box-shadow:0 4px 12px rgba(0,0,0,0.12);z-index:10;box-sizing:border-box}
  #stats{display:flex;gap:12px;align-items:center;font-size:14px;flex-wrap:wrap}
  #friendInfo{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,0.04);font-weight:600}
  #controls{display:flex;gap:8px;align-items:center}
button {
  background-color: #4caf50; /* –∑–µ–ª–µ–Ω—ã–π primary */
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: background-color 0.2s, transform 0.1s;
}
button:hover { background-color: #45a049; }
button:active { transform: translateY(1px); background-color: #3e8e41; }

/* game */
#game{display:grid;gap:1px;position:absolute;top:64px;left:0;width:100%;height:calc(100% - 64px);box-sizing:border-box}
.cell{position:relative;background-size:cover;overflow:hidden}
.cell::before{content:"";position:absolute;inset:0;background-size:cover;background-position:center;z-index:0;}
.grass-0::before{background-image:url('assets/grass_0.png')}
.grass-1::before{background-image:url('assets/grass_1.png')}
.grass-2::before{background-image:url('assets/grass_2.png')}
.tree::before{background-image:url('assets/tree.png');background-size:contain;background-repeat:no-repeat}

/* overlay player sprite */
.cell[data-occupant]::after{
  content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:70%;height:70%;
  background-image:url('assets/player.png');background-size:contain;background-repeat:no-repeat;background-position:center;
  z-index:2;pointer-events:none;border-radius:4px;
  transition: transform 150ms linear; /* –ø–ª–∞–≤–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç */
}

/* –ü–æ–≤–æ—Ä–æ—Ç –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è (–≤—Å–µ –¥–µ—Ä–∂–∞—Ç translate –≤ –Ω–∞—á–∞–ª–µ) */
.cell[data-dir="right"]::after{ transform: translate(-50%,-50%) rotate(0deg) scaleX(1); }
.cell[data-dir="left"]::after{  transform: translate(-50%,-50%) rotate(0deg) scaleX(-1); }
.cell[data-dir="down"]::after{  transform: translate(-50%,-50%) rotate(90deg); }
.cell[data-dir="up"]::after{    transform: translate(-50%,-50%) rotate(-90deg); }

/* highlights per type */
.cell[data-occupant="pash"]::after{box-shadow:0 0 5px 2px rgba(0,0,0,0.15)}
.cell[data-occupant="slavik"]::after{box-shadow:0 0 8px 3px rgba(255,193,7,0.45);filter:hue-rotate(10deg) saturate(1.1)}
.cell[data-occupant="tema"]::after{box-shadow:0 0 8px 3px rgba(33,150,243,0.45);filter:hue-rotate(200deg) saturate(1.1)}
.cell[data-occupant="kirya"]::after{box-shadow:0 0 8px 3px rgba(158,158,158,0.45);filter:grayscale(0.6) saturate(0.7)}

/* spawn pulse ‚Äî –ù–ï —Ç—Ä–æ–≥–∞–µ–º transform, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –ø–æ–≤–æ—Ä–æ—Ç */
.cell.spawn::after{animation:spawnPulse 900ms ease}
@keyframes spawnPulse{
  0%   { opacity: 0; box-shadow: 0 0 0 0 rgba(0,0,0,0); }
  50%  { opacity: 1; box-shadow: 0 0 14px 6px rgba(0,0,0,0.12); }
  100% { opacity: 1; box-shadow: 0 0 5px 2px rgba(0,0,0,0.12); }
}
</style>
</head>
<body>

<div id="header">
  <div id="stats">
    <span id="moves">‚ôüÔ∏è –•–æ–¥–æ–≤: 0</span>
    <span id="left">üåø –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–∫–æ—Å–∏—Ç—å: 100%</span>
    <span id="mood">üò∫ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: –û—Ç–ª–∏—á–Ω–æ–µ</span>
    <span id="friendInfo" style="display:none"></span>
  </div>

  <div id="controls">
    <button id="restartBtn">–†–µ—Å—Ç–∞—Ä—Ç</button>
    <button id="friendBtn">–ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞</button>
    <label style="display:flex;align-items:center;gap:4px">
      ‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:
      <input type="range" id="speedSlider" min="1" max="5" value="1">
    </label>
  </div>
</div>

<div id="game"></div>

<script>
const cellSize = 32;
let cols=0, rows=0;
const game = document.getElementById('game');
const restartBtn = document.getElementById('restartBtn');
const friendBtn = document.getElementById('friendBtn');
const friendInfo = document.getElementById('friendInfo');

let grid=[], visitCount=[], moveCount=0;
let players = [{id:'pash', type:'pash', r:0, c:0, dir:'right'}];

const FRIEND_META = {
  slavik:{name:'–°–ª–∞–≤–∏–∫', emoji:'üí™', color:'#ffc107'},
  tema:{name:'–¢—ë–º–∞', emoji:'‚ö°', color:'#2196f3'},
  kirya:{name:'–ö–∏—Ä—è', emoji:'üò¥', color:'#9e9e9e'}
};

function friendPresent(){ return players.some(p=>p.type!=='pash'); }

function findEmptyCell(){
  for(let tries=0; tries<200; tries++){
    const r=Math.floor(Math.random()*rows), c=Math.floor(Math.random()*cols);
    const cell=grid[r][c];
    if(cell.dataset.type==='grass' && !cell.dataset.occupant) return {r,c};
  }
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const cell=grid[r][c];
    if(cell.dataset.type==='grass' && !cell.dataset.occupant) return {r,c};
  }
  return {r:0,c:0};
}

function calculateGrid(){
  cols=Math.max(1,Math.floor(window.innerWidth/cellSize));
  const headerH=document.getElementById('header').offsetHeight||64;
  rows=Math.max(1,Math.floor((window.innerHeight-headerH)/cellSize));
  game.style.gridTemplateColumns=`repeat(${cols},${cellSize}px)`;
  game.style.gridTemplateRows=`repeat(${rows},${cellSize}px)`;
}

function initField(){
  calculateGrid();
  game.innerHTML=''; grid=[]; visitCount=[]; moveCount=0;

  for(let r=0;r<rows;r++){
    grid[r]=[]; visitCount[r]=[];
    for(let c=0;c<cols;c++){
      visitCount[r][c]=0;
      const div=document.createElement('div');
      div.className='cell';
      if(Math.random()<0.03){div.dataset.type='tree'; div.classList.add('tree');}
      else {div.dataset.type='grass'; div.dataset.state=0; div.dataset.mowedAt=''; div.classList.add('grass-0');}
      delete div.dataset.occupant;
      game.appendChild(div);
      grid[r][c]=div;
    }
  }

  players=[{id:'pash', type:'pash', r:0, c:0, dir:'right'}];
  const pos=findEmptyCell(); players[0].r=pos.r; players[0].c=pos.c;
  grid[pos.r][pos.c].dataset.occupant='pash';
  grid[pos.r][pos.c].dataset.dir='right';
  grid[pos.r][pos.c].classList.remove('grass-0','grass-1','grass-2');

  friendInfo.style.display='none'; friendInfo.textContent='';
  updateStats();
}

function updateGrassByMoves(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell=grid[r][c];
      if(cell.dataset.type==='grass' && cell.dataset.mowedAt){
        const age=moveCount-parseInt(cell.dataset.mowedAt||0);
        if(age>=2000){
          cell.dataset.state=0; 
          cell.dataset.mowedAt=''; 
          cell.classList.remove('grass-0','grass-1','grass-2'); 
          cell.classList.add('grass-0');
        } else if(age>=1500 && cell.dataset.state==='2'){
          cell.dataset.state=1; 
          cell.classList.remove('grass-0','grass-1','grass-2'); 
          cell.classList.add('grass-1');
        }
      }
    }
  }
}

function updateStats(){
  let totalGrass=0, mowed=0;
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const cell=grid[r][c];
    if(cell.dataset.type==='grass'){totalGrass++; if(cell.dataset.state==='2') mowed++;}
  }
  const leftPct = totalGrass? ((totalGrass-mowed)/totalGrass*100).toFixed(1) : 0;

  let totalVisits=0;
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){ if(grid[r][c].dataset.type==='grass') totalVisits+=(+visitCount[r][c]||0);}
  const avgVisits = totalGrass? totalVisits/totalGrass :0;
  let mood='üò∫ –û—Ç–ª–∏—á–Ω–æ–µ';
  if(avgVisits>2) mood='üòï –ù–µ–º–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω';
  if(avgVisits>4) mood='üòæ –ü–ª–æ—Ö–æ–µ';

  document.getElementById('moves').textContent=`‚ôüÔ∏è –•–æ–¥–æ–≤: ${moveCount}`;
  document.getElementById('left').textContent=`üåø –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–∫–æ—Å–∏—Ç—å: ${leftPct}%`;
  document.getElementById('mood').textContent=`–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${mood}`;
}

function setOccupant(r,c,type,dir){
  grid[r][c].dataset.occupant=type;
  if(dir) grid[r][c].dataset.dir=dir;
  grid[r][c].classList.add('spawn');
  setTimeout(()=>grid[r][c].classList.remove('spawn'),900);
}
function clearOccupant(r,c){ delete grid[r][c].dataset.occupant; delete grid[r][c].dataset.dir; }

function addFriend(type){
  if(friendPresent()) return;
  const pos=findEmptyCell();
  const friend={id:'friend', type:type, r:pos.r, c:pos.c, dir:'right', slavikStep:0};
  players.push(friend);
  setOccupant(pos.r,pos.c,type, 'right');
  const meta=FRIEND_META[type];
  friendInfo.style.display='inline-flex';
  friendInfo.textContent=`${meta.emoji} ${meta.name}`;
  friendInfo.style.border=`1px solid ${meta.color}`;
  friendInfo.style.color=meta.color;
  friendBtn.textContent='–ü—Ä–æ–≥–Ω–∞—Ç—å –¥—Ä—É–≥–∞';
}

function removeFriend(){
  const idx=players.findIndex(p=>p.type!=='pash'); if(idx===-1) return;
  const fr=players[idx];
  clearOccupant(fr.r,fr.c);
  players.splice(idx,1);
  friendInfo.style.display='none'; friendInfo.textContent=''; friendBtn.textContent='–ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞';
}

function moveOne(p){
  const dirs=[{dr:0,dc:1,name:'right'},{dr:0,dc:-1,name:'left'},{dr:1,dc:0,name:'down'},{dr:-1,dc:0,name:'up'}];
  let movesPerTick=1; if(p.type==='tema') movesPerTick=2;

  if(p.type==='slavik'){
    if(p.slavikStep===undefined) p.slavikStep=0;
    if(p.slavikStep%2===0){
      const cell=grid[p.r][p.c];
      if(cell.dataset.type==='grass'){
        cell.dataset.state='2';
        cell.dataset.mowedAt=moveCount;
        cell.classList.remove('grass-0','grass-1','grass-2');
        cell.classList.add('grass-2');
      }
    }
    p.slavikStep++;
    if(p.slavikStep>=6){
      const dialog=document.createElement('div');
      dialog.textContent='–Ø —É—Å—Ç–∞–ª';
      dialog.style.position='absolute';
      dialog.style.left=(p.c*cellSize)+'px';
      dialog.style.top=(p.r*cellSize)+'px';
      dialog.style.background='white';
      dialog.style.padding='4px 8px';
      dialog.style.borderRadius='6px';
      dialog.style.boxShadow='0 0 4px rgba(0,0,0,0.3)';
      dialog.style.zIndex=20;
      game.appendChild(dialog);
      setTimeout(()=>game.removeChild(dialog),2000);
      clearOccupant(p.r,p.c);
      players = players.filter(x=>x!==p);
      friendInfo.style.display='none'; friendInfo.textContent=''; friendBtn.textContent='–ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞';
      return;
    }
  }

  for(let m=0;m<movesPerTick;m++){
    const dirsShuffled=dirs.slice().sort(()=>Math.random()-0.5);
    let moved=false;
    for(const d of dirsShuffled){
      const newR=p.r+d.dr; const newC=p.c+d.dc;
      if(newR<0||newR>=rows||newC<0||newC>=cols) continue;
      const target=grid[newR][newC]; if(target.dataset.type==='tree') continue;
      clearOccupant(p.r,p.c);
      if(grid[p.r][p.c].dataset.type==='grass'){ grid[p.r][p.c].classList.remove('grass-0','grass-1','grass-2'); grid[p.r][p.c].classList.add('grass-'+grid[p.r][p.c].dataset.state);}
      p.r=newR; p.c=newC; p.dir=d.name;
      setOccupant(p.r,p.c,p.type==='pash'?'pash':p.type, p.dir);
      visitCount[p.r][p.c]=(visitCount[p.r][p.c]||0)+1;

      if(target.dataset.type==='grass'){
        if(p.type==='kirya') target.dataset.state='1';
        else target.dataset.state='2';
        target.dataset.mowedAt=moveCount;
        target.classList.remove('grass-0','grass-1','grass-2');
        target.classList.add('grass-'+target.dataset.state);
      }

      moveCount++;
      updateGrassByMoves(); updateStats();
      moved=true; break;
    }
    if(!moved) break;
  }
}

// --- —É—Å–∫–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–ª–∑—É–Ω–æ–∫ ---
let tickInterval = null;
let baseTick = 500; // –±–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É —Ö–æ–¥–∞–º–∏
let speed = 1; // –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏

const speedSlider = document.getElementById('speedSlider');
speedSlider.addEventListener('input', (e)=>{
  speed = parseInt(e.target.value);
  restartTick();
});

function restartTick(){
  if(tickInterval) clearInterval(tickInterval);
  const intervalTime = baseTick / speed;
  tickInterval = setInterval(()=>{
    const snapshot=players.slice();
    snapshot.forEach(p=>moveOne(p));
  }, intervalTime);
}

// –∫–Ω–æ–ø–∫–∏ –∏ —Å–æ–±—ã—Ç–∏—è
restartBtn.addEventListener('click',()=>{initField();});
friendBtn.addEventListener('click',()=>{
  if(friendPresent()) removeFriend();
  else {const types=['slavik','tema','kirya']; addFriend(types[Math.floor(Math.random()*types.length)]);}
});

window.addEventListener('resize',()=>{initField();});

// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
initField();
restartTick();
</script>

</body>
</html>
